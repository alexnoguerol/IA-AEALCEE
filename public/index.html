<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AEALCEE GPT</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="nav">
      <div class="nav-inner">
        <a class="brand" href="https://aealcee.org" target="_blank" rel="noopener">
          <img src="https://aealcee.org/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Flogo.70b01939.png&w=128&q=75%201x" alt="AEALCEE" onerror="this.style.display='none'"/>
          <span class="title">GPT</span>
        </a>
        <div class="nav-right">
          <div class="metrics">
            <span class="badge" title="Usuarios conectados">
              <span class="dotlive"></span>
              Usuarios conectados: <strong id="usersCount">--</strong>
            </span>
          </div>
          <a id="navExtraLink" class="nav-link" href="/admin.html">Admin</a>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="card">
        <div class="head">
          <h1>AEALCEE GPT</h1>
          <div class="actions">
            <button id="resetBtn" class="btn btn-outline" title="Reiniciar chat">
              <svg viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 0 3-6.708" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 4v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Reiniciar
            </button>
            <button id="modelBtn" class="btn btn-primary" title="Modelo en uso">--</button>
          </div>
        </div>

        <div id="log" class="chat">
          <div id="empty" class="empty">
            <div>
              <div style="font-weight:700;color:var(--primary);margin-bottom:8px">¡Hola!</div>
              <div style="color:var(--muted)">Escribe tu primera pregunta abajo para empezar.</div>
            </div>
          </div>
        </div>

        <form id="form" class="composer">
          <div class="input">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input id="msg" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" />
          </div>
          <button class="send" type="submit" id="sendBtn">
            Enviar
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M13 5l7 7-7 7" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </form>
      </div>
    </div>

    <script>
      const log = document.getElementById("log");
      const form = document.getElementById("form");
      const msg = document.getElementById("msg");
      const resetBtn = document.getElementById("resetBtn");
      const modelBtn = document.getElementById("modelBtn");
      const empty = document.getElementById("empty");
      const sendBtn = document.getElementById("sendBtn");
      const usersCountEl = document.getElementById("usersCount");
      const navExtraLink = document.getElementById("navExtraLink");

      if (navExtraLink && window.location.pathname !== "/admin.html") {
        navExtraLink.textContent = "Admin";
        navExtraLink.href = "/admin.html";
        navExtraLink.classList.add("is-visible");
      }

      let history = [];
      let typingRow = null;
      let cooldownTimer = null;

      async function refreshModelBadge() {
        try {
          const r = await fetch("/model");
          const d = await r.json();
          if (d?.model) modelBtn.textContent = d.model;
        } catch (_) {
          modelBtn.textContent = "--";
        }
      }
      async function refreshUsers() {
        try {
          const r = await fetch("/stats");
          const d = await r.json();
          if (typeof d?.users === "number") usersCountEl.textContent = String(d.users);
        } catch (_) {
          usersCountEl.textContent = "--";
        }
      }
      refreshModelBadge();
      refreshUsers();
      setInterval(refreshUsers, 8000);

      function escapeHTML(s){
        return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      }

      function addRow({who, text, typing=false}) {
        if (empty) empty.remove();
        const row = document.createElement("div");
        row.className = "row " + (who === "user" ? "user" : "bot");

        const bubble = document.createElement("div");
        bubble.className = "bubble " + (who === "user" ? "user" : "bot");

        if (typing) {
          bubble.innerHTML = `<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
        } else {
          const safe = escapeHTML(text || "");
          bubble.innerHTML = safe;
        }

        if (who === "user") {
          row.appendChild(bubble);
          const av = document.createElement("div");
          av.className = "avatar";
          av.textContent = "Tú";
          row.appendChild(av);
        } else {
          const av = document.createElement("div");
          av.className = "avatar";
          av.textContent = "AI";
          row.appendChild(av);
          row.appendChild(bubble);
        }

        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
        return row;
      }

      function setUIBusy(busy) {
        sendBtn.disabled = busy;
        msg.disabled = busy;
        const inputWrap = document.querySelector(".input");
        inputWrap.classList.toggle("disabled", busy);
      }

      function showTyping() {
        if (!typingRow) typingRow = addRow({who:"bot", typing:true});
      }
      function hideTyping() {
        if (typingRow) { typingRow.remove(); typingRow = null; }
      }

      function startCooldown(ms) {
        setUIBusy(true);
        let remaining = Math.ceil(ms / 1000);
        const original = sendBtn.textContent;
        sendBtn.textContent = `Espera ${remaining}s`;
        cooldownTimer = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            sendBtn.textContent = original;
            setUIBusy(false);
            msg.focus();
          } else {
            sendBtn.textContent = `Espera ${remaining}s`;
          }
        }, 1000);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (cooldownTimer) return;
        const text = msg.value.trim();
        if (!text) return;

        addRow({who:"user", text});
        msg.value = "";
        msg.focus();

        setUIBusy(true);
        showTyping();

        try {
          const resp = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, history }),
          });

          if (resp.status === 429) {
            const data = await resp.json().catch(() => ({}));
            hideTyping();
            addRow({who:"bot", text: data?.error || "Has enviado mensajes demasiado rápido. Espera un momento."});
            if (typeof data?.users === "number") usersCountEl.textContent = String(data.users);
            if (data?.cooldownMs) startCooldown(data.cooldownMs);
            if (data?.modelUsed) modelBtn.textContent = data.modelUsed;
            return;
          }

          const data = await resp.json();
          hideTyping();

          const reply = data.reply ?? "(sin respuesta)";
          addRow({who:"bot", text: reply});
          if (data.modelUsed) modelBtn.textContent = data.modelUsed;
          if (typeof data.users === "number") usersCountEl.textContent = String(data.users);

          history.push({ role: "user", text });
          history.push({ role: "model", text: reply });
        } catch (_) {
          hideTyping();
          addRow({who:"bot", text:"Ocurrió un error al conectar con el servidor."});
        } finally {
          if (!cooldownTimer) setUIBusy(false);
        }
      });

      resetBtn.addEventListener("click", () => {
        history = [];
        log.innerHTML = `
          <div id="empty" class="empty">
            <div>
              <div style="font-weight:700;color:var(--primary);margin-bottom:8px">Chat reiniciado</div>
              <div style="color:var(--muted)">Escribe un nuevo mensaje para comenzar.</div>
            </div>
          </div>
        `;
        msg.value = ""; msg.focus();
        hideTyping();
        if (cooldownTimer) { clearInterval(cooldownTimer); cooldownTimer = null; }
        setUIBusy(false);
        refreshModelBadge();
        refreshUsers();
      });

      msg.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });
    </script>
  </body>
</html>
